<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>打砖块</title>
  <style lang="text/css">
    #BlockBreaker{
      border: 1px solid #333;
    }
  </style>
  <script src="js/utils.js"></script>
  <script src="js/game.js"></script>
  <script src="js/level.js"></script>
  <script src="js/ball.js"></script>
  <script src="js/paddle.js"></script>
  <script src="js/block.js"></script>
</head>
<body>
  <canvas id="BlockBreaker" width="600" height="400"></canvas>
  <script>
    var loadLevel = function (level) {
      var blocks = [], plist = levels[level - 1]
      for (var i = 0; i < plist.length; i++) {
        blocks[i] = Block(plist[i])
      }
      return blocks
    }

    var __main = function () {

      // debug模式
      var enableDebugMode = function (enable) {
        if (!enable) return
        // debug： 注册keyup事件，暂停和关卡载入功能
        window.addEventListener('keyup', function (event) {
          var k = event.key
          if (k === 'p') {
            // 暂停
            paused = !paused
          } else if ('123'.includes(k)) {
            // 载入相应的关卡
            blocks = loadLevel(k)
          }
        })
      }
      enableDebugMode(true)

      // 游戏开始暂停状态
      var paused = false
      var game = Game()
      var paddle = Paddle()
      var ball = Ball()

      // 一组砖块
      var blocks = loadLevel(1)

      // 注册按键事件
      game.registerAction('a', function () {
        paddle.moveLeft()
      })
      game.registerAction('d', function () {
        paddle.moveRight(game.canvas)
      })
      game.registerAction('f', function () {
        ball.fire()
      })

      game.update = function () {
        if (paused) return

        ball.move(game.canvas)

        // 球与板子相撞反弹
        if (paddle.collide(ball)) {
          ball.rebound()
        }
        // 球与砖块相撞反弹
        for (var i = 0; i < blocks.length; i++) {
          var block = blocks[i]
          if (block.alive && block.collide(ball)) {
            block.kill()
            ball.rebound()
          }
        }
      }

      game.draw = function () {
        game.drawImage(paddle)
        game.drawImage(ball)
        
        for (var i = 0; i < blocks.length; i++) {
          var block = blocks[i]
          if (block.alive) {
            game.drawImage(block)
          }
        }
      }
    }
    __main()
  </script>
</body>
</html>